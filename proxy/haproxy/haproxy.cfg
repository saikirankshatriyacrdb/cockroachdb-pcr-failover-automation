# HAProxy Configuration for CockroachDB PCR Failover
# HAProxy supports PostgreSQL protocol and provides seamless failover
#
# Replace <YOUR_PRIMARY_SQL_DNS> and <YOUR_STANDBY_SQL_DNS> with your actual
# CockroachDB cluster SQL DNS endpoints from the CockroachDB Cloud console.

global
    log stdout format raw local0
    maxconn 4096
    # daemon  # Don't use daemon mode in Docker

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 10s
    timeout client 1h
    timeout server 1h
    retries 3

# Statistics Interface (HTTP mode for stats)
listen stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# CockroachDB Backend Pool
backend cockroach_backend
    balance roundrobin

    # Primary Cluster
    server primary <YOUR_PRIMARY_SQL_DNS>:26257 weight 100

    # Standby Cluster - Backup
    server standby <YOUR_STANDBY_SQL_DNS>:26257 weight 10 backup

# Frontend - Application Connection Point
frontend cockroach_frontend
    bind *:26257
    default_backend cockroach_backend

    # Logging
    option tcplog
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"
